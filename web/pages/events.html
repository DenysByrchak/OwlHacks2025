<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Critical meta -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Events in Philadelphia</title>

  <!-- CSS (Bootstrap + Leaflet) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

  <!-- Project CSS -->
  <link rel="stylesheet" href="../assets/css/events.css">
  <link rel="stylesheet" href="../assets/css/style.css">

  <!-- Optional head injections (favicons, meta, etc.) -->
  <script type="module">
    import { loadHead } from '../assets/js/include-head.js';
    loadHead?.();
  </script>
</head>
<body>
  <!-- Navbar mount -->
  <div id="nav-root"></div>

  <main class="events-layout" role="main">
    <!-- Left: Events list -->
    <aside class="events-list" aria-label="Event list">
      <!-- Stack header items vertically -->
      <header class="events-list__header">
        <h2 class="mb-0">Events</h2>

        <!-- Search -->
        <input
          id="search"
          type="search"
          class="form-control"
          placeholder="Search eventsâ€¦"
          aria-label="Search events"
        />

        <!-- Self-contained Bootstrap button -->
        <button
          id="findAttractionsBtn"
          type="button"
          class="btn btn-primary w-100 fw-semibold"
        >
          Find Nearby Attractions
        </button>

        <p id="locationStatus" class="location-status small text-muted mb-0" aria-live="polite"></p>
      </header>

      <ul id="eventsList" class="events-items">
        <!-- Fallback placeholders (auto-wired by JS; no per-item attrs needed) -->
        <li class="event-card">
          <h3 class="event-title">Sample Event One</h3>
          <p class="event-meta">Center City â€¢ Today 5:30 PM</p>
          <button class="event-action btn btn-outline-dark btn-sm">Add to Schedule</button>
        </li>
        <li class="event-card">
          <h3 class="event-title">Sample Event Two</h3>
          <p class="event-meta">University City â€¢ Tomorrow 2:00 PM</p>
          <button class="event-action btn btn-outline-dark btn-sm">Add to Schedule</button>
        </li>
        <li class="event-card">
          <h3 class="event-title">Sample Event Three</h3>
          <p class="event-meta">Old City â€¢ Sat 11:00 AM</p>
          <button class="event-action btn btn-outline-dark btn-sm">Add to Schedule</button>
        </li>
      </ul>
    </aside>

    <!-- Right: Map -->
    <section class="events-map" aria-label="Map">
      <div id="map" aria-label="Events map of Philadelphia"></div>
    </section>
  </main>

  <!-- Inject the modal/Toast partial (kept in its own file) -->
  <div data-include="/pages/add-to-schedule.html"></div>

  <!-- JS: Leaflet first, then Bootstrap bundle for modal/toast -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Project JS -->
  <script type="module">
    import { loadNav } from '../assets/js/include-nav.js';
    import { bootMap } from '../assets/js/map-setup.js';

    loadNav('events');

    const readyForLeaflet = () =>
      window.L ? Promise.resolve() : new Promise(resolve => {
        const i = setInterval(() => { if (window.L) { clearInterval(i); resolve(); } }, 20);
      });

    let map;
    readyForLeaflet().then(() => {
      map = bootMap();
      window.map = map;
      setTimeout(() => map && map.invalidateSize(), 0);
      window.addEventListener('resize', () => map && map.invalidateSize());
    });

    /**
     * Helper: turn event object into DOM <li> and auto-wire data-* for the modal.
     * You don't have to hand-edit each item.
     */
    function makeEventLI(ev) {
      const li = document.createElement('li');
      li.className = 'event-card';

      // Prefer ISO fields if your API has them; fall back to strings
      const title = ev.title ?? 'Untitled Event';
      const location = ev.neighborhood ?? ev.location ?? 'Philadelphia';
      const startIso = ev.startIso ?? ev.startISO ?? ev.startTimeIso ?? '';

      li.innerHTML = `
        <h3 class="event-title">${title}</h3>
        <p class="event-meta">${location} â€¢ ${ev.time ?? ev.startText ?? ''}</p>
        <button class="event-action btn btn-outline-primary btn-sm">Add to Schedule</button>
      `;

      // Auto-add the data attributes the modal script expects (no manual markup)
      const btn = li.querySelector('.event-action');
      btn.dataset.addToSchedule = '';           // presence is enough
      btn.dataset.id = ev.id ?? crypto.randomUUID?.() ?? `ev-${Date.now()}`;
      btn.dataset.title = title;
      btn.dataset.location = location;
      if (startIso) btn.dataset.startIso = startIso;

      return li;
    }

    async function loadEvents() {
      const list = document.getElementById('eventsList');
      if (!list) return;

      // First, auto-wire the fallback samples already in the HTML
      list.querySelectorAll('.event-card').forEach((card, idx) => {
        const title = card.querySelector('.event-title')?.textContent?.trim() || `Sample Event ${idx+1}`;
        const meta = card.querySelector('.event-meta')?.textContent || '';
        const location = meta.split('â€¢')[0].trim() || 'Philadelphia';
        const btn = card.querySelector('.event-action');
        if (!btn) return;
        btn.classList.add('btn','btn-outline-dark','btn-sm');
        btn.dataset.addToSchedule = '';
        btn.dataset.id = `sample-${idx+1}`;
        btn.dataset.title = title;
        btn.dataset.location = location;
        // Optional: guess a start time so the modal has a sensible default
        const guess = new Date(); guess.setHours(17,30,0,0);
        btn.dataset.startIso = guess.toISOString();
      });

      // Then, try to replace with real events from API
      try {
        const res = await fetch('/api/events');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const events = await res.json();
        if (!Array.isArray(events) || events.length === 0) return;

        list.innerHTML = '';
        events.forEach(ev => list.appendChild(makeEventLI(ev)));
      } catch (err) {
        console.error('Failed to load events:', err);
        const li = document.createElement('li');
        li.className = 'event-card event-card--error';
        li.textContent = 'Error loading events ðŸ˜¢';
        list.prepend(li);
      }
    }
    loadEvents();
  </script>

  <!-- Geolocation helper (uses #findAttractionsBtn and #locationStatus) -->
  <script src="../assets/js/find-attractions.js" defer></script>

  <!-- Partials loader (injects /pages/add-to-schedule.html) -->
  <script src="../assets/js/partials.js"></script>

  <!-- Modal wiring + localStorage schedule logic -->
  <script src="../assets/js/schedule.js"></script>
</body>
</html>
