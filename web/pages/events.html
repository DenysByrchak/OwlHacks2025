<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Critical meta -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Events in Philadelphia</title>

  <!-- CSS (load synchronously so map has height/styles) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <!-- Use relative paths since this file lives in /pages/ -->
  <link rel="stylesheet" href="../assets/css/bootstrap-overrides.css">
  <link rel="stylesheet" href="../assets/css/events.css">
  <link rel="stylesheet" href="../assets/css/style.css">

  <!-- Optional head injections (favicons, meta, etc.) -->
  <script type="module">
    import { loadHead } from '../assets/js/include-head.js';
    // Safe to no-op if the module simply augments <head>
    loadHead?.();
  </script>
</head>
<body>
  <!-- Navbar mount -->
  <div id="nav-root"></div>

  <main class="events-layout" role="main">
    <!-- Left: Events list -->
    <aside class="events-list" aria-label="Event list">
      <header class="events-list__header">
        <h2 class="mb-0">Events</h2>

        <input
          class="events-search"
          id="search"
          type="search"
          placeholder="Search eventsâ€¦"
          aria-label="Search events"
        />

        <button id="findAttractionsBtn" class="find-attractions-btn">
          Find Nearby Attractions
        </button>
        <p id="locationStatus" class="location-status" aria-live="polite"></p>
      </header>

      <ul id="eventsList" class="events-items">
        <!-- Populated by JS; fallback placeholders render if fetch fails -->
        <li class="event-card">
          <h3 class="event-title">Sample Event One</h3>
          <p class="event-meta">Center City â€¢ Today 5:30 PM</p>
          <button class="event-action">Add to Schedule</button>
        </li>
        <li class="event-card">
          <h3 class="event-title">Sample Event Two</h3>
          <p class="event-meta">University City â€¢ Tomorrow 2:00 PM</p>
          <button class="event-action">Add to Schedule</button>
        </li>
        <li class="event-card">
          <h3 class="event-title">Sample Event Three</h3>
          <p class="event-meta">Old City â€¢ Sat 11:00 AM</p>
          <button class="event-action">Add to Schedule</button>
        </li>
      </ul>
    </aside>

    <!-- Right: Map -->
    <section class="events-map" aria-label="Map">
      <div id="map" aria-label="Events map of Philadelphia"></div>
    </section>
  </main>

  <!-- Leaflet JS must be available before bootMap() runs -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>

  <script type="module">
    import { loadNav } from '../assets/js/include-nav.js';
    import { bootMap } from '../assets/js/map-setup.js';

    // Inject navbar and mark current page active (events)
    loadNav('events');

    // Wait for Leaflet (L) to be defined, then boot the map
    const readyForLeaflet = () =>
      window.L ? Promise.resolve() : new Promise(resolve => {
        const i = setInterval(() => { if (window.L) { clearInterval(i); resolve(); } }, 20);
      });

    let map;
    readyForLeaflet()
      .then(() => {
        map = bootMap();
        window.map = map;

        // Ensure Leaflet sizes correctly in the flex layout
        setTimeout(() => map && map.invalidateSize(), 0);
        window.addEventListener('resize', () => map && map.invalidateSize());
      });

    // Load events from backend and render them (IDs now consistent)
    async function loadEvents() {
      const list = document.getElementById('eventsList');
      if (!list) return;

      try {
        const res = await fetch('/api/events');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const events = await res.json();

        // If backend returns nothing, keep placeholders
        if (!Array.isArray(events) || events.length === 0) return;

        list.innerHTML = '';
        events.forEach(ev => {
          const li = document.createElement('li');
          li.className = 'event-card';
          li.innerHTML = `
            <h3 class="event-title">${ev.title ?? 'Untitled Event'}</h3>
            <p class="event-meta">${ev.neighborhood ?? 'Philadelphia'} â€¢ ${ev.time ?? ''}</p>
            <button class="event-action" data-id="${ev.id ?? ''}">View</button>
          `;
          list.appendChild(li);
        });
      } catch (err) {
        console.error('Failed to load events:', err);
        // Keep placeholders, but show an inline error card at the top
        const li = document.createElement('li');
        li.className = 'event-card event-card--error';
        li.textContent = 'Error loading events ðŸ˜¢';
        list.prepend(li);
      }
    }
    loadEvents();
  </script>

  <!-- Geolocation helper (uses #findAttractionsBtn and #locationStatus) -->
  <script src="../assets/js/find-attractions.js" defer></script>
</body>
</html>
