<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Philly Itinerary — Linked List & Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { overflow-x: hidden; }
    #savedEvents { max-height: calc(100vh - 140px); overflow-y: auto; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: .5rem; }
    .day { min-height: 90px; border: 1px solid var(--bs-border-color); border-radius: .5rem; padding: .25rem .35rem; position: relative; }
    .day-number { position: absolute; top: .25rem; right: .4rem; font-size: .85rem; color: var(--bs-secondary-color); }
    .day.has-event { border-color: var(--bs-primary); }
    .day.selected { outline: 3px solid var(--bs-primary); outline-offset: 0; }
    .no-wrap { white-space: nowrap; }
    .location-pill { font-size: .75rem; }
    .conflict-pill { font-size: .7rem; }
  </style>
</head>
<body class="bg-light">
  <header class="w-100 bg-primary text-white text-center py-3 mb-3">
    <h1 class="h4 mb-0">Philadelphia Trip Planner</h1>
    <p class="mb-0 opacity-75">Saved list ↔ calendar, duration-aware, conflict-checking</p>
  </header>

  <main class="container-fluid">
    <div class="row g-3">
      <!-- Left: Saved (Favorited) Events -->
      <aside class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Saved events</span>
            <div class="d-flex gap-2">
              <button id="addMockBtn" class="btn btn-sm btn-outline-secondary">Add mock</button>
              <button id="clearSavedBtn" class="btn btn-sm btn-outline-danger">Clear</button>
            </div>
          </div>
          <div id="savedEvents" class="list-group list-group-flush" aria-label="Saved events list"></div>
        </div>
      </aside>

      <!-- Right: Calendar / Details -->
      <section class="col-12 col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
              <h2 id="monthLabel" class="h5 mb-0"></h2>
              <span class="badge text-bg-light">current month only</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button id="toggleViewBtn" class="btn btn-sm btn-primary" disabled>
                <span class="no-wrap">Show details</span>
              </button>
            </div>
          </div>

          <div id="calendarView" class="card-body">
            <div class="calendar" id="calendarGrid" aria-label="Calendar grid"></div>
            <div class="mt-3 small text-secondary">Tip: Click a saved event on the left to highlight its day. Click a day cell to see events on that day.</div>
          </div>

          <div id="detailsView" class="card-body" hidden>
            <div id="detailsContent"></div>
            <div class="mt-3">
              <button class="btn btn-outline-secondary" id="backToCalendarBtn">Back to calendar</button>
            </div>
          </div>
        </div>

        <!-- All events (fetched + Philly-only) -->
        <div class="card mt-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>All events in Philadelphia</span>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" id="useLocationBtn">Use my location</button>
              <button class="btn btn-sm btn-outline-primary" id="refreshBtn">Refresh</button>
            </div>
          </div>
          <div class="list-group list-group-flush" id="allEvents"></div>
        </div>
      </section>
    </div>
  </main>

  <template id="savedItemTpl">
    <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
      <div class="ms-2 me-auto">
        <div class="fw-semibold title"></div>
        <div class="small text-secondary meta"></div>
      </div>
      <span class="badge rounded-pill align-self-center btn-remove" title="Remove from saved">✕</span>
    </button>
  </template>

  <template id="allEventTpl">
    <div class="list-group-item d-flex justify-content-between align-items-start">
      <div class="ms-2 me-auto">
        <div class="fw-semibold title"></div>
        <div class="small text-secondary meta"></div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge text-bg-warning conflict-pill d-none">Conflict</span>
        <button class="btn btn-sm btn-outline-primary btn-save">Add to saved</button>
      </div>
    </div>
  </template>

  <script>
    // ===== City & Shape =====
    const CITY = "Philadelphia";
    // Internal event shape:
    // { id, title, date:'YYYY-MM-DD', time:'h:mm AM', desc, location, lat, lon, favorited,
    //   durationMinutes?: number, url?, thumbnail?, price? }

    // ===== Duration / Time helpers =====
    function monthDayToISOThisYear(mdStr){
      const now = new Date();
      const y = now.getFullYear();
      const d = new Date(`${mdStr} ${y}`);
      if (isNaN(d.getTime())) return `${y}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
      return `${y}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function normalizeDuration(val){
      if (val == null) return null;
      if (typeof val === 'number' && !isNaN(val)) return Math.max(0, Math.floor(val));
      if (typeof val === 'string'){
        const m = val.match(/(?:(\d+)\s*h)?\s*(?:(\d+)\s*m)?/i);
        if (m){ const h = m[1]?parseInt(m[1],10):0; const mins = m[2]?parseInt(m[2],10):0; if (h||mins) return h*60+mins; }
        const asNum = parseInt(val,10); if (!isNaN(asNum)) return asNum;
      }
      return null;
    }
    function startDateTime(ev){ return new Date(`${ev.date} ${ev.time}`); }
    function endDateTime(ev){ const s = startDateTime(ev); if (!ev.durationMinutes) return null; return new Date(s.getTime() + ev.durationMinutes*60000); }
    function fmtTime(d){ return d.toLocaleTimeString([], { hour:'numeric', minute:'2-digit' }); }
    function timeRangeLabel(ev){ const s=startDateTime(ev), e=endDateTime(ev); return e?`${fmtTime(s)} – ${fmtTime(e)}`:ev.time; }
    function overlaps(a,b){
      if (a.date !== b.date) return false;
      const sa = startDateTime(a), sb = startDateTime(b);
      const ea = endDateTime(a) || new Date(sa.getTime()+3600000);
      const eb = endDateTime(b) || new Date(sb.getTime()+3600000);
      return sa < eb && sb < ea;
    }

    // ===== External JSON mapping =====
    function mapExternalToInternal(raw){
      const isoDate = monthDayToISOThisYear(raw.date);
      const location = Array.isArray(raw.address) ? raw.address.join(', ') : (raw.address || 'Philadelphia');
      return {
        id: crypto.randomUUID(),
        title: raw.title || 'Untitled',
        date: isoDate,
        time: raw.time || '12:00 PM',
        desc: raw.price ? `Price: ${raw.price}` : '',
        location,
        lat: null, lon: null,
        favorited: false,
        durationMinutes: normalizeDuration(raw.durationMinutes ?? raw.duration),
        url: raw.url,
        thumbnail: raw.thumbnail,
        price: raw.price,
      };
    }
    // quick helper to ingest one external event at runtime
    window.ingestExternalJson = function(raw){
      const ev = mapExternalToInternal(raw);
      demoEvents.push(ev);
      renderAllEvents(demoEvents);
    }

    // ===== Demo/Backend =====
    async function fetchPhillyEvents(){
      return [
        { id: 'e1', title: 'Independence Hall Tour', date: offsetDay(2), time: '10:00 AM', desc: 'Guided tour of the birthplace of America.', location: '520 Chestnut St', lat: 39.9489, lon: -75.1500, favorited: true,  durationMinutes: 60 },
        { id: 'e2', title: 'Reading Terminal Market Lunch', date: offsetDay(3), time: '12:30 PM', desc: 'Cheesesteaks, roast pork, donuts—food crawl.', location: '1136 Arch St', lat: 39.9534, lon: -75.1590, favorited: false, durationMinutes: 90 },
        { id: 'e3', title: 'Museum of the American Revolution', date: offsetDay(5), time: '2:00 PM', desc: 'Revolutionary War exhibits.', location: '101 S 3rd St', lat: 39.9486, lon: -75.1452, favorited: true,  durationMinutes: 120 },
        { id: 'e4', title: 'Spruce Street Harbor Park', date: offsetDay(5), time: '6:00 PM', desc: 'Hammocks, lights, snacks.', location: '301 S Christopher Columbus Blvd', lat: 39.9437, lon: -75.1403, favorited: false, durationMinutes: 105 },
        { id: 'e5', title: 'Citizens Bank Park Game', date: offsetDay(8), time: '7:05 PM', desc: 'Phillies home game — BSL → NRG.', location: '1 Citizens Bank Way', lat: 39.9057, lon: -75.1665, favorited: false, durationMinutes: 180 },
        { id: 'e6', title: 'Rocky Steps & Art Museum', date: offsetDay(4), time: '4:30 PM', desc: 'Run the steps, then the galleries.', location: '2600 Benjamin Franklin Pkwy', lat: 39.9656, lon: -75.1809, favorited: false, durationMinutes: 75 },
        { id: 'e7', title: 'Magic Gardens', date: offsetDay(6), time: '1:00 PM', desc: 'Isaiah Zagar’s mosaic labyrinth.', location: '1020 South St', lat: 39.9426, lon: -75.1607, favorited: false, durationMinutes: 80 },
      ];
    }

    // ===== State =====
    let saved = new Map();
    let selectedEventId = null;
    let demoEvents = [];

    // ===== Helpers =====
    function offsetDay(d){
      const today = new Date();
      const y = today.getFullYear();
      const m = today.getMonth();
      const base = new Date(y, m, today.getDate() + d);
      if (base.getMonth() !== m){
        const last = new Date(y, m + 1, 0).getDate();
        return `${y}-${String(m+1).padStart(2,'0')}-${String(last).padStart(2,'0')}`;
      }
      return `${base.getFullYear()}-${String(base.getMonth()+1).padStart(2,'0')}-${String(base.getDate()).padStart(2,'0')}`;
    }
    function fmtDateLabel(iso){
      const d = new Date(iso + 'T00:00:00');
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }
    function dayNum(iso){ return Number(iso.slice(-2)); }
    function todayMonthInfo(){
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      const first = new Date(y, m, 1);
      const daysInMonth = new Date(y, m + 1, 0).getDate();
      const label = first.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
      return { y, m, daysInMonth, label };
    }

    // ===== Calendar =====
    function renderCalendar(){
      const grid = document.getElementById('calendarGrid');
      const { daysInMonth, label } = todayMonthInfo();
      document.getElementById('monthLabel').textContent = label;
      grid.innerHTML = '';
      for (let d = 1; d <= daysInMonth; d++){
        const cell = document.createElement('button');
        cell.type = 'button';
        cell.className = 'day bg-white text-start';
        cell.dataset.day = String(d);
        const n = document.createElement('span');
        n.className = 'day-number';
        n.textContent = d;
        cell.appendChild(n);
        const list = document.createElement('div');
        list.className = 'small';
        cell.appendChild(list);
        const todays = [...saved.values()].filter(ev => dayNum(ev.date) === d);
        if (todays.length){
          cell.classList.add('has-event');
          todays.forEach(ev => {
            const pill = document.createElement('div');
            pill.className = 'badge text-bg-primary text-truncate w-100 mb-1';
            pill.textContent = `${fmtTime(startDateTime(ev))}${endDateTime(ev)?'–'+fmtTime(endDateTime(ev)):''} ${ev.title}`;
            pill.title = ev.title;
            list.appendChild(pill);
          });
        }
        cell.addEventListener('click', () => {
          const first = todays[0];
          document.querySelectorAll('.day.selected').forEach(el => el.classList.remove('selected'));
          cell.classList.add('selected');
          if (first){ selectEvent(first.id); showDetails(); }
        });
        grid.appendChild(cell);
      }
    }

    // ===== Saved list =====
    function renderSaved(){
      const wrap = document.getElementById('savedEvents');
      wrap.innerHTML = '';
      const tpl = document.getElementById('savedItemTpl');
      if (!saved.size){
        const empty = document.createElement('div');
        empty.className = 'list-group-item text-secondary';
        empty.textContent = 'No saved events yet. Use "Add to saved" below.';
        wrap.appendChild(empty);
      } else {
        [...saved.values()].sort((a,b)=>a.date.localeCompare(b.date)).forEach(ev => {
          const li = tpl.content.firstElementChild.cloneNode(true);
          li.querySelector('.title').textContent = ev.title;
          li.querySelector('.meta').textContent = `${fmtDateLabel(ev.date)} • ${timeRangeLabel(ev)} • ${ev.location}`;
          li.addEventListener('click', (e) => {
            if (e.target.closest('.btn-remove')) return;
            selectEvent(ev.id);
            highlightDay(ev.date);
          });
          li.querySelector('.btn-remove').addEventListener('click', () => {
            saved.delete(ev.id);
            renderSaved();
            renderCalendar();
          });
          wrap.appendChild(li);
        });
      }
      document.getElementById('toggleViewBtn').disabled = !selectedEventId;
    }

    // ===== Geolocation (optional) =====
    let userCoords = null; function toRad(x){return x*Math.PI/180}
    function haversine(a,b){ if(!a||!b) return null; const R=6371; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon); const lat1=toRad(a.lat), lat2=toRad(b.lat); const s=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(s)); }

    // ===== All events =====
    function renderAllEvents(list){
      const wrap = document.getElementById('allEvents');
      wrap.innerHTML = '';
      const tpl = document.getElementById('allEventTpl');
      const sorted = [...list].sort((a,b)=>{
        const byDate = a.date.localeCompare(b.date);
        if (userCoords && a.lat && b.lat){
          const da = haversine(userCoords, {lat:a.lat,lon:a.lon}) || 0;
          const db = haversine(userCoords, {lat:b.lat,lon:b.lon}) || 0;
          if (Math.abs(da-db) > 0.25) return da - db;
        }
        return byDate;
      });
      sorted.forEach(ev => {
        const row = tpl.content.firstElementChild.cloneNode(true);
        row.querySelector('.title').innerHTML = `${ev.title} <span class="badge text-bg-light location-pill">${CITY}</span>`;
        const distance = userCoords && ev.lat ? ` • ~${(haversine(userCoords,{lat:ev.lat,lon:ev.lon})||0).toFixed(1)} km` : '';
        row.querySelector('.meta').textContent = `${fmtDateLabel(ev.date)} • ${timeRangeLabel(ev)} • ${ev.location}${distance}`;
        const conflict = [...saved.values()].some(s => overlaps(s, ev));
        const conflictBadge = row.querySelector('.conflict-pill');
        if (conflict) conflictBadge.classList.remove('d-none');
        const btn = row.querySelector('.btn-save');
        btn.textContent = saved.has(ev.id) ? 'Saved' : 'Add to saved';
        btn.disabled = saved.has(ev.id);
        btn.addEventListener('click', () => {
          const hasConflict = [...saved.values()].some(s => overlaps(s, ev));
          if (hasConflict && !confirm('This overlaps with an already-saved event. Save anyway?')) return;
          saved.set(ev.id, ev);
          renderSaved();
          renderCalendar();
          btn.textContent = 'Saved';
          btn.disabled = true;
        });
        wrap.appendChild(row);
      });
    }

    // ===== Selection & details =====
    function selectEvent(id){
      selectedEventId = id;
      const ev = [...saved.values(), ...demoEvents].find(x => x.id === id);
      if (!ev) return;
      const details = document.getElementById('detailsContent');
      details.innerHTML = `
        <h3 class="h5">${ev.title}</h3>
        <div class="text-secondary mb-2">${fmtDateLabel(ev.date)} • ${timeRangeLabel(ev)} • ${ev.location}</div>
        ${ev.url ? `<a href="${ev.url}" target="_blank" class="btn btn-sm btn-link px-0">Open link</a>` : ''}
        <p class="mb-0 mt-2">${ev.desc || ''}</p>
        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-outline-primary" id="ensureSavedBtn">${saved.has(id) ? 'Saved' : 'Add to saved'}</button>
          <button class="btn btn-outline-secondary" id="jumpToDayBtn">Jump to day</button>
        </div>`;
      document.getElementById('toggleViewBtn').disabled = false;
      document.getElementById('ensureSavedBtn').addEventListener('click', () => { saved.set(id, ev); renderSaved(); renderCalendar(); selectEvent(id); });
      document.getElementById('jumpToDayBtn').addEventListener('click', () => { highlightDay(ev.date); showCalendar(); });
    }
    function highlightDay(iso){
      const d = dayNum(iso);
      document.querySelectorAll('.day.selected').forEach(el => el.classList.remove('selected'));
      const cell = document.querySelector(`.day[data-day="${d}"]`);
      if (cell){ cell.classList.add('selected'); cell.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'nearest' }); }
      showDetails();
    }
    function showDetails(){ document.getElementById('calendarView').hidden = true; document.getElementById('detailsView').hidden = false; document.getElementById('toggleViewBtn').querySelector('span').textContent = 'Back to calendar'; }
    function showCalendar(){ document.getElementById('calendarView').hidden = false; document.getElementById('detailsView').hidden = true; document.getElementById('toggleViewBtn').querySelector('span').textContent = 'Show details'; }

    // ===== Wire buttons =====
    document.getElementById('toggleViewBtn').addEventListener('click', () => {
      const showingDetails = !document.getElementById('detailsView').hidden; if (showingDetails) showCalendar(); else showDetails();
    });
    document.getElementById('backToCalendarBtn').addEventListener('click', showCalendar);
    document.getElementById('clearSavedBtn').addEventListener('click', () => { saved.clear(); renderSaved(); renderCalendar(); });
    document.getElementById('addMockBtn').addEventListener('click', () => {
      const ev = { id: crypto.randomUUID(), title: 'Custom Note', date: offsetDay(1), time: '3:00 PM', desc: 'Your custom reminder.', location: '—', lat: null, lon: null, durationMinutes: 30 };
      saved.set(ev.id, ev); renderSaved(); renderCalendar();
    });
    document.getElementById('refreshBtn').addEventListener('click', async () => { demoEvents = await fetchPhillyEvents(); renderAllEvents(demoEvents); });
    document.getElementById('useLocationBtn').addEventListener('click', async () => {
      if (!navigator.geolocation) return alert('Geolocation not supported in this browser.');
      navigator.geolocation.getCurrentPosition((pos)=>{ userCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude }; renderAllEvents(demoEvents); }, ()=>{ alert('Could not get your location.'); }, { enableHighAccuracy:true, timeout:8000 });
    });

    // ===== Init =====
    (async function init(){
      demoEvents = await fetchPhillyEvents();
      demoEvents.filter(e => e.favorited).forEach(e => saved.set(e.id, e));
      renderSaved(); renderCalendar(); renderAllEvents(demoEvents);
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>